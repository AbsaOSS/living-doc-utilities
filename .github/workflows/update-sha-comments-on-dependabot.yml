name: Sync GitHub Actions SHA comments on Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect:
    name: Workflows Changes Detection
    runs-on: ubuntu-latest
    outputs:
      workflows_changed: ${{ steps.changes.outputs.workflows_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Check if .github/workflows/ changed
        id: changes
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            RANGE="${{ github.event.pull_request.base.sha }}...${{ github.sha }}"
          else
            RANGE="${{ github.sha }}~1...${{ github.sha }}"
          fi
          if git diff --name-only "$RANGE" | grep -qE '^\.github/workflows/'; then
            echo "workflows_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "workflows_changed=false" >> "$GITHUB_OUTPUT"
          fi

  sync-comments:
    name: Sync GitHub Actions SHA comments
    needs: detect
    if: needs.detect.outputs.workflows_changed == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd
        with:
          ref: ${{ github.head_ref }}

      - name: Install Python deps
        run: |
          python -m pip install --quiet requests

      - name: Update version comments for pinned GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python <<'PY'
          import os
          import re
          import requests
          from pathlib import Path

          token = os.getenv("GITHUB_TOKEN")
          if not token:
            raise SystemExit("GITHUB_TOKEN is required")

          headers = {
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github+json",
          }

          # Regex: uses: owner/repo@<40-char-sha> [# comment]
          uses_regex = re.compile(
            r'^(\s*uses:\s+)([\w\.-]+\/[\w\.-]+)@([0-9a-fA-F]{40})(\s*(?:#.*)?)$'
          )

          tags_cache = {}

          def get_tags(owner, repo):
            key = f"{owner}/{repo}"
            if key in tags_cache:
              return tags_cache[key]
            tags = []
            page = 1
            while page <= 5:  # max 500 tags
              url = f"https://api.github.com/repos/{owner}/{repo}/tags"
              resp = requests.get(
                url,
                headers=headers,
                params={"per_page": 100, "page": page},
                timeout=10,
              )
              if resp.status_code != 200:
                break
              data = resp.json()
              if not data:
                break
              tags.extend(data)
              if len(data) < 100:
                break
              page += 1
            tags_cache[key] = tags
            return tags

          def find_tag_for_sha(owner, repo, sha):
            tags = get_tags(owner, repo)
            for tag in tags:
              tag_sha = tag.get("commit", {}).get("sha", "")
              if tag_sha.startswith(sha[:7]):
                return tag.get("name")
            return None

          workflow_dir = Path(".github/workflows")
          changed_files = []

          for file in workflow_dir.glob("*.yml"):
            original = file.read_text()
            new_lines = []
            changed = False

            for line in original.splitlines():
              m = uses_regex.match(line)
              if not m:
                new_lines.append(line)
                continue

              prefix, action, sha, suffix = m.groups()

              owner, repo = action.split("/", 1)

              tag = find_tag_for_sha(owner, repo, sha)
              if tag:
                new_line = f"{prefix}{action}@{sha} # {tag}"
                if new_line != line:
                  changed = True
                  new_lines.append(new_line)
                else:
                  new_lines.append(line)
              else:
                new_lines.append(line)

            if changed:
              file.write_text("\n".join(new_lines) + "\n")
              changed_files.append(str(file))

          if changed_files:
            print("Updated comments in:")
            for f in changed_files:
              print(" -", f)
          else:
            print("No changes needed")
          PY

      - name: Commit changes back to Dependabot branch
        if: ${{ success() }}
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3
        with:
          commit_message: "chore: sync GitHub Actions version comments"
          branch: ${{ github.head_ref }}
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

  noop:
    name: No Operation Needed
    needs: detect
    if: needs.detect.outputs.workflows_changed == 'false'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No changes under workflows/ â€” passing."
